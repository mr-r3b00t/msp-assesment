<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Cloud Backup Service Detailed Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .error { color: red; font-size: 0.875rem; display: none; }
        .conditional { display: none; }
        .question-number { display: inline-block; width: 2rem; font-weight: bold; }
        .logo { width: 100px; height: auto; }
        .dark-mode-toggle { cursor: pointer; }
        .dark .bg-gray-100 { background-color: #1a202c; }
        .dark .bg-white { background-color: #2d3748; }
        .dark .bg-gray-200 { background-color: #2d3748; }
        .dark .border-gray-300 { border-color: #4a5568; }
        .dark .text-red-500 { color: #ffffff; }
        .dark * { color: #ffffff !important; }
        .dark input, .dark select, .dark textarea { background-color: #4a5568; border-color: #6b7280; }
        .dark input::placeholder, .dark textarea::placeholder { color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col justify-between min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-5xl mx-auto mt-4 relative">
        <!-- Light/Dark Mode Toggle (Top Left) -->
        <div class="absolute top-4 left-4">
            <i id="themeToggle" class="fas fa-lightbulb text-2xl text-gray-900 dark-mode-toggle"></i>
        </div>
        <!-- Logo (Top Right) -->
        <div class="absolute top-4 right-4">
            <img src="logo.png" alt="Xservus Limited Logo" class="logo">
        </div>
        <h1 class="text-3xl font-bold mb-8 text-center text-gray-900">MSP Cloud Backup Service Detailed Assessment</h1>
        <div id="errorMessage" class="text-red-500 text-center mb-4 hidden">Failed to load questions. Please check the console for details.</div>
        <form id="assessmentForm" class="space-y-8">
            <!-- Assessor and Organisation Details -->
            <div class="border p-6 rounded border-gray-300">
                <h2 class="text-2xl font-semibold mb-6 text-gray-900">Assessment Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-1 text-gray-900">Assessor’s Name</label>
                        <input type="text" name="assessorName" class="w-full p-2 border rounded border-gray-300 text-gray-900" required>
                        <p id="assessorNameError" class="error">Please provide the assessor’s name.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-900">Date</label>
                        <input type="date" name="assessmentDate" class="w-full p-2 border rounded border-gray-300 text-gray-900" required>
                        <p id="assessmentDateError" class="error">Please provide the date.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-900">Assessment Company Name</label>
                        <input type="text" name="companyName" class="w-full p-2 border rounded border-gray-300 text-gray-900" required>
                        <p id="companyNameError" class="error">Please provide the company name.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-900">Assessor’s Company Website</label>
                        <input type="url" name="companyWebsite" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="https://example.com" required>
                        <p id="companyWebsiteError" class="error">Please provide a valid URL.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-900">Organisation Being Assessed</label>
                        <input type="text" name="organisation" class="w-full p-2 border rounded border-gray-300 text-gray-900" required>
                        <p id="organisationError" class="error">Please provide the organisation name.</p>
                    </div>
                    <div>
                        <label class="block mb-1 text-gray-900">Service Being Assessed</label>
                        <input type="text" name="service" class="w-full p-2 border rounded border-gray-300 text-gray-900" required>
                        <p id="serviceError" class="error">Please provide the service name.</p>
                    </div>
                </div>
            </div>
            <!-- Service Overview -->
            <div class="border p-6 rounded border-gray-300">
                <h2 class="text-2xl font-semibold mb-6 text-gray-900">Service Overview</h2>
                <div>
                    <label class="block mb-1 text-gray-900">Service Description</label>
                    <textarea name="serviceDescription" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="Provide a detailed description of the service being assessed" required></textarea>
                    <p id="serviceDescriptionError" class="error">Please provide the service description.</p>
                </div>
            </div>
            <!-- Dynamic Questions from JSON -->
        </form>
    </div>

    <!-- Clear State Button -->
    <div class="text-center mt-4">
        <button id="clearStateButton" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">Clear Form State</button>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-200 dark:bg-gray-800 text-center py-4 mt-4">
        <p class="text-gray-900">Copyright Xservus Limited</p>
        <p class="text-gray-900">Version 0.1</p>
    </footer>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
            }
        });

        // Function to toggle conditional fields
        function toggleField(fieldId, show) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.style.display = show ? 'block' : 'none';
                const inputs = field.querySelectorAll('input, select, textarea');
                inputs.forEach(input => input.required = show);
            }
        }

        // Function to save form state to localStorage
        function saveFormState() {
            const form = document.getElementById('assessmentForm');
            const formData = {};
            
            // Save text, url, date, number inputs, and textareas
            const inputs = form.querySelectorAll('input[type="text"], input[type="url"], input[type="date"], input[type="number"], select, textarea');
            inputs.forEach(input => {
                formData[input.name] = input.value;
            });

            // Save radio inputs
            const radios = form.querySelectorAll('input[type="radio"]:checked');
            radios.forEach(radio => {
                formData[radio.name] = radio.value;
            });

            // Save checkboxes
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (!formData[checkbox.name]) {
                    formData[checkbox.name] = [];
                }
                if (checkbox.checked) {
                    formData[checkbox.name].push(checkbox.value);
                }
            });

            localStorage.setItem('mspAssessmentState', JSON.stringify(formData));
        }

        // Function to load form state from localStorage
        function loadFormState() {
            const savedState = localStorage.getItem('mspAssessmentState');
            if (savedState) {
                const formData = JSON.parse(savedState);
                const form = document.getElementById('assessmentForm');

                // Load text, url, date, number inputs, and textareas
                const inputs = form.querySelectorAll('input[type="text"], input[type="url"], input[type="date"], input[type="number"], select, textarea');
                inputs.forEach(input => {
                    if (formData[input.name]) {
                        input.value = formData[input.name];
                    }
                });

                // Load radio inputs
                const radios = form.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    if (formData[radio.name] === radio.value) {
                        radio.checked = true;
                        const fieldId = radio.getAttribute('onclick')?.match(/'conditional-[^']*'/);
                        if (fieldId) {
                            toggleField(fieldId[0].replace(/'/g, ''), true);
                        }
                    }
                });

                // Load checkboxes
                const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (formData[checkbox.name] && formData[checkbox.name].includes(checkbox.value)) {
                        checkbox.checked = true;
                    }
                });
            }
        }

        // Function to clear form state
        function clearFormState() {
            localStorage.removeItem('mspAssessmentState');
            document.getElementById('assessmentForm').reset();
            const conditionals = document.querySelectorAll('.conditional');
            conditionals.forEach(conditional => {
                conditional.style.display = 'none';
                conditional.querySelectorAll('input, select, textarea').forEach(input => input.required = false);
            });
            window.location.reload(); // Reload to reset dynamic content
        }

        // Function to export form data to JSON
        function exportToJSON() {
            const formData = JSON.parse(localStorage.getItem('mspAssessmentState') || '{}');
            const blob = new Blob([JSON.stringify(formData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'assessment_responses.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Function to generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const formData = JSON.parse(localStorage.getItem('mspAssessmentState') || '{}');
            let y = 10;

            // Header
            doc.setFontSize(16);
            doc.text('MSP Cloud Backup Service Detailed Assessment', 10, y);
            y += 10;
            doc.setFontSize(12);
            doc.text('Generated on: ' + new Date().toLocaleString(), 10, y);
            y += 10;

            // Assessment Details
            doc.setFontSize(14);
            doc.text('Assessment Details', 10, y);
            y += 10;
            doc.setFontSize(10);
            const assessmentDetails = [
                { label: 'Assessor’s Name', key: 'assessorName' },
                { label: 'Date', key: 'assessmentDate' },
                { label: 'Assessment Company Name', key: 'companyName' },
                { label: 'Assessor’s Company Website', key: 'companyWebsite' },
                { label: 'Organisation Being Assessed', key: 'organisation' },
                { label: 'Service Being Assessed', key: 'service' }
            ];
            assessmentDetails.forEach(detail => {
                doc.text(`${detail.label}: ${formData[detail.key] || 'N/A'}`, 10, y);
                y += 7;
            });

            // Service Overview
            y += 5;
            doc.setFontSize(14);
            doc.text('Service Overview', 10, y);
            y += 10;
            doc.setFontSize(10);
            const serviceDescription = formData['serviceDescription'] || 'N/A';
            const descriptionLines = doc.splitTextToSize(`Service Description: ${serviceDescription}`, 180);
            doc.text(descriptionLines, 10, y);
            y += descriptionLines.length * 7;

            // Dynamic Questions
            y += 5;
            doc.setFontSize(14);
            doc.text('Assessment Questions', 10, y);
            y += 10;
            doc.setFontSize(10);
            fetch('questions.json')
                .then(response => response.json())
                .then(data => {
                    data.sections.forEach(section => {
                        if (y > 270) {
                            doc.addPage();
                            y = 10;
                        }
                        doc.setFontSize(12);
                        doc.text(section.name, 10, y);
                        y += 7;
                        const items = section.subsections || [{ questions: section.questions }];
                        items.forEach(subsection => {
                            if (subsection.name) {
                                if (y > 270) {
                                    doc.addPage();
                                    y = 10;
                                }
                                doc.setFontSize(10);
                                doc.text(subsection.name, 15, y);
                                y += 7;
                            }
                            subsection.questions.forEach(question => {
                                if (y > 270) {
                                    doc.addPage();
                                    y = 10;
                                }
                                const response = formData[`q${question.number}`] || (Array.isArray(formData[`q${question.number}`]) ? formData[`q${question.number}`].join(', ') : 'N/A');
                                const questionText = `${question.number}. ${question.text}: ${response}`;
                                const lines = doc.splitTextToSize(questionText, 180);
                                doc.text(lines, 20, y);
                                y += lines.length * 7;
                                if (question.conditional && formData[`q${question.number}`] === question.conditional.trigger) {
                                    question.conditional.fields.forEach(field => {
                                        if (y > 270) {
                                            doc.addPage();
                                            y = 10;
                                        }
                                        const fieldName = `q${question.number}-${field.text.replace(/\s/g, '')}`;
                                        const fieldResponse = formData[fieldName] || (Array.isArray(formData[fieldName]) ? formData[fieldName].join(', ') : 'N/A');
                                        const fieldText = `${field.number ? `${field.number}. ` : ''}${field.text}: ${fieldResponse}`;
                                        const fieldLines = doc.splitTextToSize(fieldText, 170);
                                        doc.text(fieldLines, 25, y);
                                        y += fieldLines.length * 7;
                                    });
                                }
                            });
                        });
                    });
                    doc.save('assessment_responses.pdf');
                })
                .catch(error => console.error('Error loading questions for PDF:', error));
        }

        // Function to generate form elements from JSON
        function renderForm(data) {
            const form = document.getElementById('assessmentForm');
            data.sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'border p-6 rounded border-gray-300';
                sectionDiv.innerHTML = `<h2 class="text-2xl font-semibold mb-6 text-gray-900">${section.name}</h2>`;

                const items = section.subsections || [{ questions: section.questions }];
                items.forEach(subsection => {
                    if (subsection.name) {
                        const subsectionDiv = document.createElement('div');
                        subsectionDiv.className = 'mb-6';
                        subsectionDiv.innerHTML = `<h3 class="text-xl font-medium mb-4 text-gray-900">${subsection.name}</h3>`;
                        sectionDiv.appendChild(subsectionDiv);
                        renderQuestions(subsection.questions, subsectionDiv);
                    } else {
                        renderQuestions(subsection.questions, sectionDiv);
                    }
                });

                form.appendChild(sectionDiv);
            });

            const submitDiv = document.createElement('div');
            submitDiv.className = 'text-center';
            submitDiv.innerHTML = '<button type="submit" class="bg-blue-500 text-white px-8 py-3 rounded hover:bg-blue-600">Submit Assessment</button>';
            form.appendChild(submitDiv);

            // Load saved state after rendering
            loadFormState();

            // Add event listeners for saving state
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', saveFormState);
                input.addEventListener('input', saveFormState);
            });
        }

        // Function to render questions
        function renderQuestions(questions, parentDiv) {
            questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'mb-4';
                let html = `<p class="font-medium text-gray-900"><span class="question-number">${question.number}.</span> ${question.text}</p>`;

                if (question.type === 'radio') {
                    question.options.forEach(option => {
                        const fieldId = question.conditional && option === question.conditional.trigger ? `conditional-${question.number}` : '';
                        html += `
                            <label class="mr-4">
                                <input type="radio" name="q${question.number}" value="${option}" 
                                    ${question.conditional && option === question.conditional.trigger ? `onclick="toggleField('${fieldId}', this.checked)"` : ''}>
                                ${option}
                            </label>`;
                    });
                    html += `<p id="q${question.number}Error" class="error">Please select an option.</p>`;
                } else if (question.type === 'select') {
                    html += `
                        <select name="q${question.number}" class="w-full p-2 border rounded border-gray-300 text-gray-900">
                            ${question.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        <p id="q${question.number}Error" class="error">Please select an option.</p>`;
                } else if (question.type === 'textarea') {
                    html += `
                        <textarea name="q${question.number}" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="Enter details"></textarea>
                        <p id="q${question.number}Error" class="error">Please provide details.</p>`;
                } else if (question.type === 'number') {
                    html += `
                        <input type="number" name="q${question.number}" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="e.g., 365">
                        <p id="q${question.number}Error" class="error">Please provide a number.</p>`;
                } else if (question.type === 'date') {
                    html += `
                        <input type="date" name="q${question.number}" class="w-full p-2 border rounded border-gray-300 text-gray-900">
                        <p id="q${question.number}Error" class="error">Please provide a date.</p>`;
                } else if (question.type === 'checkbox') {
                    question.options.forEach(option => {
                        html += `
                            <label class="block">
                                <input type="checkbox" name="q${question.number}" value="${option}" class="text-gray-900">
                                ${option}
                            </label>`;
                    });
                    html += `<p id="q${question.number}Error" class="error">Please select at least one option.</p>`;
                }

                if (question.conditional) {
                    const conditionalDiv = document.createElement('div');
                    conditionalDiv.id = `conditional-${question.number}`;
                    conditionalDiv.className = 'conditional mt-2';
                    question.conditional.fields.forEach(field => {
                        let fieldHtml = `<label class="block mb-1 text-gray-900">${field.number ? `<span class="question-number">${field.number}.</span> ` : ''}${field.text}</label>`;
                        const fieldName = `q${question.number}-${field.text.replace(/\s/g, '')}`;
                        if (field.type === 'select') {
                            fieldHtml += `
                                <select name="${fieldName}" class="w-full p-2 border rounded border-gray-300 text-gray-900 mb-2">
                                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>`;
                        } else if (field.type === 'text' || field.type === 'number' || field.type === 'date' || field.type === 'url') {
                            fieldHtml += `<input type="${field.type}" name="${fieldName}" class="w-full p-2 border rounded border-gray-300 text-gray-900 mb-2" placeholder="Enter ${field.text.toLowerCase()}">`;
                        } else if (field.type === 'textarea') {
                            fieldHtml += `<textarea name="${fieldName}" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="Enter ${field.text.toLowerCase()}"></textarea>`;
                        } else if (field.type === 'radio') {
                            field.options.forEach(opt => {
                                const subFieldId = field.conditional && opt === field.conditional.trigger ? `conditional-${question.number}-${field.text.replace(/\s/g, '')}` : '';
                                fieldHtml += `
                                    <label class="mr-4">
                                        <input type="radio" name="${fieldName}" value="${opt}" 
                                            ${field.conditional && opt === field.conditional.trigger ? `onclick="toggleField('${subFieldId}', this.checked)"` : ''}>
                                        ${opt}
                                    </label>`;
                            });
                        }
                        fieldHtml += `<p id="${fieldName}Error" class="error">Please provide ${field.text.toLowerCase()}.</p>`;

                        if (field.conditional) {
                            const subConditionalDiv = document.createElement('div');
                            subConditionalDiv.id = `conditional-${question.number}-${field.text.replace(/\s/g, '')}`;
                            subConditionalDiv.className = 'conditional mt-2';
                            field.conditional.fields.forEach(subField => {
                                let subFieldHtml = `<label class="block mb-1 text-gray-900">${subField.text}</label>`;
                                const subFieldName = `q${question.number}-${field.text.replace(/\s/g, '')}-${subField.text.replace(/\s/g, '')}`;
                                if (subField.type === 'textarea') {
                                    subFieldHtml += `<textarea name="${subFieldName}" class="w-full p-2 border rounded border-gray-300 text-gray-900" placeholder="Enter ${subField.text.toLowerCase()}"></textarea>`;
                                }
                                subFieldHtml += `<p id="${subFieldName}Error" class="error">Please provide ${subField.text.toLowerCase()}.</p>`;
                                subConditionalDiv.innerHTML += subFieldHtml;
                            });
                            fieldHtml += subConditionalDiv.outerHTML;
                        }

                        conditionalDiv.innerHTML += fieldHtml;
                    });
                    questionDiv.innerHTML = html;
                    questionDiv.appendChild(conditionalDiv);
                } else {
                    questionDiv.innerHTML = html;
                }

                parentDiv.appendChild(questionDiv);
            });
        }

        // Clear state button event listener
        document.getElementById('clearStateButton').addEventListener('click', clearFormState);

        // Form validation
        document.getElementById('assessmentForm').addEventListener('submit', function(event) {
            event.preventDefault();
            let isValid = true;

            // Validate assessor, organisation, and service overview fields
            const staticFields = [
                'assessorName', 'assessmentDate', 'companyName', 'companyWebsite', 
                'organisation', 'service', 'serviceDescription'
            ];
            staticFields.forEach(field => {
                const input = document.querySelector(`[name="${field}"]`);
                const error = document.getElementById(`${field}Error`);
                if (input && !input.value.trim()) {
                    error.style.display = 'block';
                    isValid = false;
                } else if (input && error) {
                    error.style.display = 'none';
                }
                // URL validation for companyWebsite
                if (field === 'companyWebsite' && input && input.value.trim()) {
                    try {
                        new URL(input.value);
                        error.style.display = 'none';
                    } catch {
                        error.style.display = 'block';
                        isValid = false;
                    }
                }
            });

            // Validate radio groups
            const radioGroups = document.querySelectorAll('input[type="radio"]');
            const radioNames = new Set([...radioGroups].map(r => r.name));
            radioNames.forEach(name => {
                const radios = document.querySelectorAll(`input[name="${name}"]:checked`);
                const error = document.getElementById(`${name}Error`);
                if (error && radios.length === 0) {
                    error.style.display = 'block';
                    isValid = false;
                } else if (error) {
                    error.style.display = 'none';
                }
            });

            // Validate selects, textareas, numbers, and dates
            const inputs = document.querySelectorAll('select, textarea, input[type="number"], input[type="date"]');
            inputs.forEach(input => {
                if (input.required && !input.value.trim()) {
                    const error = document.getElementById(`${input.name}Error`);
                    if (error) {
                        error.style.display = 'block';
                        isValid = false;
                    }
                } else {
                    const error = document.getElementById(`${input.name}Error`);
                    if (error) error.style.display = 'none';
                }
            });

            // Validate checkboxes
            const checkboxGroups = document.querySelectorAll('input[type="checkbox"]');
            const checkboxNames = new Set([...checkboxGroups].map(c => c.name));
            checkboxNames.forEach(name => {
                const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
                const error = document.getElementById(`${name}Error`);
                if (error && checked.length === 0) {
                    error.style.display = 'block';
                    isValid = false;
                } else if (error) {
                    error.style.display = 'none';
                }
            });

            if (isValid) {
                alert('Assessment submitted successfully!');
                exportToJSON();
                generatePDF();
                clearFormState();
            }
        });
    </script>
</body>
</html>
